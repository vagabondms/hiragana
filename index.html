<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>히라가나 공부</title>
    <style>
        :root {
            /* Colors */
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --text-primary: #333;
            --text-secondary: #666;
            --surface-white: white;
            --shadow-light: rgba(0, 0, 0, 0.2);
            --shadow-medium: rgba(0, 0, 0, 0.3);
            --shadow-dark: rgba(0, 0, 0, 0.5);

            /* Sizes */
            --card-width: 400px;
            --card-height: 300px;
            --card-padding: 60px 40px;
            --card-radius: 20px;
            --character-size: 120px;
            --hint-size: 18px;

            /* Animations */
            --flip-duration: 0.6s;
            --slide-duration: 0.3s;
            --hover-duration: 0.2s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        /* Settings Button */
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--surface-white);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px var(--shadow-light);
            transition: transform var(--hover-duration), box-shadow var(--hover-duration);
            z-index: 100;
        }

        .settings-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--shadow-medium);
        }

        .settings-btn:active {
            transform: scale(0.95);
        }

        /* Card System */
        .card-container {
            perspective: 1000px;
            cursor: pointer;
            position: relative;
            width: var(--card-width);
            height: var(--card-height);
        }

        .card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform var(--flip-duration);
            transform-style: preserve-3d;
        }

        /* Card States */
        .card.flipped {
            transform: rotateY(180deg);
        }

        .card.flipped.slide-out-flipped {
            animation: card-exit var(--slide-duration) ease-in forwards;
        }

        .card.slide-in {
            animation: card-enter var(--slide-duration) ease-out forwards;
        }

        /* Animations */
        @keyframes card-exit {
            from {
                transform: translateX(0) rotateY(180deg);
                opacity: 1;
            }
            to {
                transform: translateX(100%) rotateY(180deg);
                opacity: 0;
            }
        }

        @keyframes card-enter {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Card Faces */
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            background: var(--surface-white);
            padding: var(--card-padding);
            border-radius: var(--card-radius);
            box-shadow: 0 20px 60px var(--shadow-medium);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .card-back {
            transform: rotateY(180deg);
        }

        /* Content */
        .character {
            font-size: var(--character-size);
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 20px;
            white-space: nowrap;
        }

        .hint {
            font-size: var(--hint-size);
            color: var(--text-secondary);
            margin-top: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --card-width: min(90vw, 350px);
                --card-height: 250px;
                --card-padding: 40px 20px;
                --character-size: 80px;
                --hint-size: 14px;
            }

            .settings-btn {
                top: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            :root {
                --card-width: min(90vw, 300px);
                --card-height: 220px;
                --card-padding: 30px 15px;
                --character-size: 60px;
                --hint-size: 12px;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--shadow-dark);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface-white);
            padding: 40px;
            border-radius: var(--card-radius);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1;
            transition: color var(--hover-duration);
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        /* Row Selection */
        .row-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .row-checkbox {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all var(--hover-duration);
        }

        .row-checkbox:hover {
            border-color: var(--bg-gradient-start);
            background: #f8f9ff;
        }

        .row-checkbox input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .row-checkbox.checked {
            border-color: var(--bg-gradient-start);
            background: var(--bg-gradient-start);
            color: var(--surface-white);
        }

        .row-checkbox label {
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
        }

        .apply-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--surface-white);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform var(--hover-duration);
        }

        .apply-btn:hover {
            transform: translateY(-2px);
        }

        .apply-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <button class="settings-btn" id="settingsBtn">⚙️</button>

    <div class="card-container" id="cardContainer">
        <div class="card" id="card1">
            <div class="card-face card-front">
                <div class="character" id="characterFront1">準備中...</div>
                <div class="hint">스페이스바 또는 클릭/터치하여 시작</div>
            </div>
            <div class="card-face card-back">
                <div class="character" id="characterBack1"></div>
                <div class="hint">다시 클릭/터치하여 다음 문제</div>
            </div>
        </div>
        <div class="card" id="card2" style="display: none;">
            <div class="card-face card-front">
                <div class="character" id="characterFront2"></div>
                <div class="hint">스페이스바 또는 클릭/터치하여 시작</div>
            </div>
            <div class="card-face card-back">
                <div class="character" id="characterBack2"></div>
                <div class="hint">다시 클릭/터치하여 다음 문제</div>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>학습할 행 선택</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="row-selection" id="rowSelection"></div>
            <button class="apply-btn" id="applyBtn">적용</button>
        </div>
    </div>

    <script>
        // 히라가나 데이터 (행별 분류)
        const hiraganaData = {
            A: [
                { hiragana: 'あ', korean: '아' },
                { hiragana: 'い', korean: '이' },
                { hiragana: 'う', korean: '우' },
                { hiragana: 'え', korean: '에' },
                { hiragana: 'お', korean: '오' }
            ],
            K: [
                { hiragana: 'か', korean: '카' },
                { hiragana: 'き', korean: '키' },
                { hiragana: 'く', korean: '쿠' },
                { hiragana: 'け', korean: '케' },
                { hiragana: 'こ', korean: '코' }
            ],
            S: [
                { hiragana: 'さ', korean: '사' },
                { hiragana: 'し', korean: '시' },
                { hiragana: 'す', korean: '스' },
                { hiragana: 'せ', korean: '세' },
                { hiragana: 'そ', korean: '소' }
            ],
            T: [
                { hiragana: 'た', korean: '타' },
                { hiragana: 'ち', korean: '치' },
                { hiragana: 'つ', korean: '츠' },
                { hiragana: 'て', korean: '테' },
                { hiragana: 'と', korean: '토' }
            ],
            N: [
                { hiragana: 'な', korean: '나' },
                { hiragana: 'に', korean: '니' },
                { hiragana: 'ぬ', korean: '누' },
                { hiragana: 'ね', korean: '네' },
                { hiragana: 'の', korean: '노' }
            ],
            H: [
                { hiragana: 'は', korean: '하' },
                { hiragana: 'ひ', korean: '히' },
                { hiragana: 'ふ', korean: '후' },
                { hiragana: 'へ', korean: '헤' },
                { hiragana: 'ほ', korean: '호' }
            ],
            M: [
                { hiragana: 'ま', korean: '마' },
                { hiragana: 'み', korean: '미' },
                { hiragana: 'む', korean: '무' },
                { hiragana: 'め', korean: '메' },
                { hiragana: 'も', korean: '모' }
            ],
            Y: [
                { hiragana: 'や', korean: '야' },
                { hiragana: 'ゆ', korean: '유' },
                { hiragana: 'よ', korean: '요' }
            ],
            R: [
                { hiragana: 'ら', korean: '라' },
                { hiragana: 'り', korean: '리' },
                { hiragana: 'る', korean: '루' },
                { hiragana: 'れ', korean: '레' },
                { hiragana: 'ろ', korean: '로' }
            ],
            W: [
                { hiragana: 'わ', korean: '와' },
                { hiragana: 'を', korean: '오(을)' },
                { hiragana: 'ん', korean: 'ㄴ' }
            ]
        };

        // 상태 관리
        let state = 'initial'; // initial, korean, hiragana
        let currentChar = null;
        let selectedRows = ['A', 'K', 'S', 'T', 'N', 'H', 'M', 'Y', 'R', 'W'];
        let availableChars = [];
        let recentHistory = []; // 최근 나온 글자들 저장 (반복 방지)
        let activeCard = 1; // 현재 활성화된 카드 (1 또는 2)
        let isAnimating = false; // 애니메이션 진행 중 플래그
        let card1State = 'front'; // 'front' 또는 'back'
        let card2State = 'front'; // 'front' 또는 'back'

        // DOM 요소
        const card1El = document.getElementById('card1');
        const card2El = document.getElementById('card2');
        const characterFront1El = document.getElementById('characterFront1');
        const characterBack1El = document.getElementById('characterBack1');
        const characterFront2El = document.getElementById('characterFront2');
        const characterBack2El = document.getElementById('characterBack2');
        const cardContainerEl = document.getElementById('cardContainer');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeModalBtn = document.getElementById('closeModal');
        const applyBtn = document.getElementById('applyBtn');
        const rowSelectionEl = document.getElementById('rowSelection');

        // 현재 활성 카드의 DOM 요소 가져오기
        function getActiveCardElements() {
            if (activeCard === 1) {
                return {
                    cardEl: card1El,
                    frontEl: characterFront1El,
                    backEl: characterBack1El
                };
            } else {
                return {
                    cardEl: card2El,
                    frontEl: characterFront2El,
                    backEl: characterBack2El
                };
            }
        }

        // 비활성 카드의 DOM 요소 가져오기
        function getInactiveCardElements() {
            if (activeCard === 1) {
                return {
                    cardEl: card2El,
                    frontEl: characterFront2El,
                    backEl: characterBack2El
                };
            } else {
                return {
                    cardEl: card1El,
                    frontEl: characterFront1El,
                    backEl: characterBack1El
                };
            }
        }

        // 로컬 스토리지에서 설정 불러오기
        function loadSettings() {
            const saved = localStorage.getItem('selectedRows');
            if (saved) {
                selectedRows = JSON.parse(saved);
            }
            updateAvailableChars();
        }

        // 사용 가능한 글자 업데이트
        function updateAvailableChars() {
            availableChars = [];
            selectedRows.forEach(row => {
                if (hiraganaData[row]) {
                    availableChars.push(...hiraganaData[row]);
                }
            });
        }

        // 랜덤 글자 선택 (진짜 랜덤 - 최근 것 제외)
        function getRandomChar() {
            if (availableChars.length === 0) return null;

            // 사용 가능한 글자가 적으면 히스토리 크기 조정
            const historySize = Math.min(Math.floor(availableChars.length / 2), 5);

            // 최근 히스토리에 없는 글자들만 필터링
            let candidateChars = availableChars.filter(char =>
                !recentHistory.some(recent =>
                    recent.hiragana === char.hiragana && recent.korean === char.korean
                )
            );

            // 후보가 없으면 (모두 최근 것) 히스토리 초기화
            if (candidateChars.length === 0) {
                recentHistory = [];
                candidateChars = availableChars;
            }

            // 랜덤 선택
            const randomIndex = Math.floor(Math.random() * candidateChars.length);
            const selectedChar = candidateChars[randomIndex];

            // 히스토리에 추가
            recentHistory.push(selectedChar);
            if (recentHistory.length > historySize) {
                recentHistory.shift(); // 오래된 것 제거
            }

            return selectedChar;
        }

        // 각 카드의 상태 가져오기/설정하기
        function getCardState(cardNum) {
            return cardNum === 1 ? card1State : card2State;
        }

        function setCardState(cardNum, newState) {
            if (cardNum === 1) {
                card1State = newState;
            } else {
                card2State = newState;
            }
        }

        // 다음 단계로 진행
        function nextStep() {
            // 애니메이션 중에는 입력 무시
            if (isAnimating) return;

            const active = getActiveCardElements();
            const activeCardNum = activeCard;

            if (state === 'initial') {
                // 한국어 표시 (앞면)
                currentChar = getRandomChar();
                if (!currentChar) {
                    active.frontEl.textContent = '행을 선택해주세요';
                    return;
                }
                active.frontEl.textContent = currentChar.korean;
                active.backEl.textContent = currentChar.hiragana;
                active.cardEl.classList.remove('flipped', 'slide-out-flipped', 'slide-in');
                setCardState(activeCardNum, 'front');
                state = 'korean';
            } else if (state === 'korean') {
                // 카드 뒤집기 - 히라가나 표시 (뒷면)
                isAnimating = true;
                active.cardEl.classList.add('flipped');
                setCardState(activeCardNum, 'back');
                state = 'hiragana';

                // 플립 애니메이션 완료 후
                setTimeout(() => {
                    isAnimating = false;
                }, 600);
            } else if (state === 'hiragana') {
                // 다음 글자로 - 카드 슬라이드 애니메이션
                isAnimating = true;
                const inactive = getInactiveCardElements();
                const inactiveCardNum = activeCard === 1 ? 2 : 1;

                // 1. 새 글자 가져오기
                currentChar = getRandomChar();
                if (!currentChar) {
                    active.frontEl.textContent = '행을 선택해주세요';
                    active.cardEl.classList.remove('flipped', 'slide-out-flipped', 'slide-in');
                    setCardState(activeCardNum, 'front');
                    state = 'initial';
                    isAnimating = false;
                    return;
                }

                // 2. 비활성 카드를 앞면 상태로 설정하고 새 데이터 넣기 (한국어 보이게)
                inactive.frontEl.textContent = currentChar.korean;
                inactive.backEl.textContent = currentChar.hiragana;
                inactive.cardEl.classList.remove('flipped', 'slide-out-flipped', 'slide-in');
                setCardState(inactiveCardNum, 'front');
                inactive.cardEl.style.display = 'block';

                // 3. 현재 카드를 flipped 상태 유지하면서 슬라이드 아웃 (일본어 보이면서 나가기)
                // flipped 클래스를 유지한 채로 slide-out-flipped 추가
                active.cardEl.classList.add('slide-out-flipped');

                // 5. 동시에 새 카드 슬라이드 인 (한국어 보이면서 들어오기)
                requestAnimationFrame(() => {
                    inactive.cardEl.classList.add('slide-in');
                });

                // 6. 애니메이션 완료 후 정리
                setTimeout(() => {
                    active.cardEl.style.display = 'none';
                    active.cardEl.classList.remove('flipped', 'slide-out-flipped');
                    setCardState(activeCardNum, 'front');
                    inactive.cardEl.classList.remove('slide-in');
                    activeCard = inactiveCardNum;
                    state = 'korean';
                    isAnimating = false;
                }, 300);
            }
        }

        // 설정 모달 렌더링
        function renderSettings() {
            rowSelectionEl.innerHTML = '';
            Object.keys(hiraganaData).forEach(row => {
                const isChecked = selectedRows.includes(row);
                const div = document.createElement('div');
                div.className = `row-checkbox ${isChecked ? 'checked' : ''}`;
                div.innerHTML = `
                    <input type="checkbox" id="row-${row}" ${isChecked ? 'checked' : ''}>
                    <label for="row-${row}">${row}행</label>
                `;

                const checkbox = div.querySelector('input');
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        div.classList.add('checked');
                    } else {
                        div.classList.remove('checked');
                    }
                });

                rowSelectionEl.appendChild(div);
            });
        }

        // 설정 적용
        function applySettings() {
            selectedRows = [];
            document.querySelectorAll('.row-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
                const row = checkbox.id.replace('row-', '');
                selectedRows.push(row);
            });

            if (selectedRows.length === 0) {
                alert('최소 하나의 행을 선택해주세요!');
                return;
            }

            localStorage.setItem('selectedRows', JSON.stringify(selectedRows));
            updateAvailableChars();
            settingsModal.classList.remove('active');

            // 상태 초기화
            state = 'initial';
            activeCard = 1;
            card1State = 'front';
            card2State = 'front';
            isAnimating = false;
            card1El.style.display = 'block';
            card2El.style.display = 'none';
            characterFront1El.textContent = '準備中...';
            card1El.classList.remove('flipped', 'slide-out-flipped', 'slide-in');
            card2El.classList.remove('flipped', 'slide-out-flipped', 'slide-in');
        }

        // 이벤트 리스너
        const openSettings = (e) => {
            e.stopPropagation();
            e.preventDefault();
            renderSettings();
            settingsModal.classList.add('active');
        };

        settingsBtn.addEventListener('click', openSettings);
        settingsBtn.addEventListener('touchend', openSettings);

        const closeSettings = () => {
            settingsModal.classList.remove('active');
        };

        closeModalBtn.addEventListener('click', closeSettings);
        closeModalBtn.addEventListener('touchend', closeSettings);

        const closeOnBackdrop = (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('active');
            }
        };

        settingsModal.addEventListener('click', closeOnBackdrop);
        settingsModal.addEventListener('touchend', closeOnBackdrop);

        applyBtn.addEventListener('click', applySettings);
        applyBtn.addEventListener('touchend', applySettings);

        // 스페이스바 이벤트
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                nextStep();
            }
        });

        // 클릭 및 터치 이벤트
        const handleNext = (e) => {
            e.preventDefault();
            nextStep();
        };

        cardContainerEl.addEventListener('click', handleNext);
        cardContainerEl.addEventListener('touchend', handleNext);

        // 초기화
        loadSettings();
    </script>
</body>
</html>
